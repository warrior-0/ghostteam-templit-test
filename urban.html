<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>괴담 | 괴담지옥</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="main.js"></script>
  <script type="module">
    import { renderUrbanList, updateUrbanTitle } from './urban.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjHwHbHlCi4vgv-Ma0-3kqt-M3SLI_oF4",
      authDomain: "ghost-38f07.firebaseapp.com",
      projectId: "ghost-38f07",
      storageBucket: "ghost-38f07.appspot.com",
      messagingSenderId: "776945022976",
      appId: "1:776945022976:web:105e545d39f12b5d0940e5",
      measurementId: "G-B758ZC971V"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.addEventListener('DOMContentLoaded', async () => {
      const urbanList = document.getElementById('urbanList');
      const idParam = new URLSearchParams(window.location.search).get('id');
      const filterParam = new URLSearchParams(window.location.search).get('filter') || 'all';

      let sortType = 'latest';
      renderUrbanList(sortType, filterParam);
      updateUrbanTitle(filterParam);

      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
          document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          sortType = this.dataset.sort;

          if (sortType === 'popular') {
            // Firebase에서 좋아요 정보 가져와서 urbanData와 매칭 후 정렬
            const { urbanData } = await import('./urban.js');
            const updatedUrbanData = await Promise.all(urbanData.map(async story => {
              const likeRef = doc(db, 'urbanLikes', String(story.id));
              const likeSnap = await getDoc(likeRef);
              return {
                ...story,
                likes: likeSnap.exists() ? (likeSnap.data().count || 0) : 0
              };
            }));
            updatedUrbanData.sort((a, b) => b.likes - a.likes);

            urbanList.innerHTML = updatedUrbanData.map(item => `
              <div class="product-card urban-item" data-id="${item.id}" style="cursor:pointer;">
                <img src="${item.thumb}" alt="${item.title}">
                <div class="urban-item-title" style="margin-bottom:0.5rem;">${item.title}</div>
                <div class="urban-item-meta" style="margin-bottom:0.4rem;">
                  <span>좋아요 ${item.likes}개</span>
                  <span>${item.date}</span>
                </div>
                <div style="color:#e01c1c;font-size:0.95rem;margin-bottom:0.2rem;">공포 난이도: ${'★'.repeat(item.level)}${'☆'.repeat(5 - item.level)}</div>
              </div>
            `).join('');

            document.querySelectorAll('.urban-item').forEach(itemElem => {
              itemElem.addEventListener('click', function () {
                const clickId = this.getAttribute('data-id');
                window.history.pushState({}, '', `?id=${clickId}`);
                import('./urban.js').then(module => module.renderUrbanDetail(parseInt(clickId, 10)));
              });
            });
          } else {
            renderUrbanList(sortType, filterParam);
          }
        });
      });
    });
  </script>
</head>
<body>
  <header>
    <div class="header-inner">
      <div style="display: flex; align-items: center;">
        <div id="menuContainer"></div>
        <a href="index.html" class="logo">괴담지옥</a>
        <nav>
          <ul class="gnb">
            <li><a href="index.html">홈</a></li>
            <li id="urbanMenu">
              <div class="dropdown" tabindex="0">
                <a href="urban.html">괴담</a>
                <span class="dropdown-arrow">&#9660;</span>
              </div>
              <div class="submenu">
                <a href="urban.html?filter=all">전체 괴담 모음</a>
                <a href="urban.html?filter=korea">한국 괴담</a>
                <a href="urban.html?filter=foreign">해외 괴담</a>
                <a href="urban.html?filter=true">실화 이야기</a>
                <a href="urban.html?filter=user">사용자 제보 괴담</a>
              </div>
            </li>
            <li id="communityMenu">
              <div class="dropdown" tabindex="0">
                <a href="community.html">커뮤니티</a>
                <span class="dropdown-arrow">&#9660;</span>
              </div>
              <div class="submenu">
                <a href="community.html?board=free">자유게시판</a>
                <a href="community.html?board=notice">이벤트/공지</a>
                <a href="community.html?board=archive">자료실</a>
              </div>
            </li>
            <li id="aboutMenu">
              <div class="dropdown" tabindex="0">
                <a href="about.html">정보</a>
                <span class="dropdown-arrow">&#9660;</span>
              </div>
              <div class="submenu">
                <a href="about.html?page=intro">사이트 소개</a>
                <a href="about.html?page=greeting">운영자 인사말</a>
                <a href="about.html?page=contact">문의/제보하기</a>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="main-section">
      <h2 class="urban-title">괴담 모음</h2>
      <div class="urban-sort">
        <button class="sort-btn active" data-sort="latest">최신순</button>
        <button class="sort-btn" data-sort="popular">인기순</button>
        <button class="sort-btn" data-sort="level">공포 난이도순</button>
      </div>
      <div class="product-list" id="urbanList">
        <!-- 괴담 카드/상세가 JS로 렌더링됩니다 -->
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 괴담지옥. All rights reserved.
  </footer>
</body>
</html>
